#
# SPDX-FileCopyrightText: Copyright 2025 Arm Limited and/or its affiliates <open-source-office@arm.com>
# SPDX-License-Identifier: Apache-2.0
#
name: Build ML SDK

on:
  push:
    branches:
      - macos_ci
  workflow_dispatch:
  workflow_call:
    inputs:
      changed_repo: { type: string, required: true }  # e.g., org/repo-a
      changed_sha:  { type: string, required: true }  # e.g., 40-char sha

permissions:
  contents: read
  packages: read

env:
  MANIFEST_URL: https://github.com/${{ github.repository_owner }}/ai-ml-sdk-manifest.git
  REPO_DIR: ${{ github.workspace }}/sdk
  INSTALL_DIR: ${{ github.workspace }}/install
  CHANGED_REPO: ${{ inputs.changed_repo }}
  CHANGED_SHA: ${{ inputs.changed_sha }}

jobs:
#  build:
#    runs-on: ${{ matrix.platform }}
#    strategy:
#      matrix:
#        include:
#          - platform: ubuntu-24.04
#            arch_tag: amd64
#          - platform: ubuntu-24.04-arm
#            arch_tag: arm64
#      fail-fast: false
#
#    container:
#      image: ghcr.io/${{ github.repository_owner }}/ml-sdk-linux-${{ matrix.arch_tag }}:latest
#      credentials:
#        username: ${{ github.actor }}
#        password: ${{ secrets.GITHUB_TOKEN }}
#      options: --user root
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Clone repositories and build
#        run: .github/workflows/scripts/ci_build.sh

  build_macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'


      - name: Setup Vulkan SDK + SwiftShader
        id: vulkan
        uses: NcStudios/VulkanCI@v1.2
        with:
          # Pick any supported SDK version (this is the default one)
          sdkVersion: 1.4.309.0
#      - name: build lavapipe
#        id: build_lavapipe
#        run: |
#          zsh .github/workflows/scripts/build_lavapipe_macos.zsh
#
#          # Lavapipe env
#          echo "MESA_LAVAPIPE_PREFIX=$HOME/.local/mesa-lavapipe" >> "$GITHUB_ENV"
#          echo "VK_DRIVER_FILES=$HOME/.local/mesa-lavapipe/share/vulkan/icd.d/lvp_icd.aarch64.json" >> "$GITHUB_ENV"
#          echo "VK_ICD_FILENAMES=$HOME/.local/mesa-lavapipe/share/vulkan/icd.d/lvp_icd.aarch64.json" >> "$GITHUB_ENV"
#
#          # Make the Vulkan loader from Homebrew visible to dlopen
#          BREW_VK_PREFIX="$(brew --prefix vulkan-loader)"
#          echo "DYLD_LIBRARY_PATH=$INSTALL_DIR/lib:$BREW_VK_PREFIX/lib:\$DYLD_LIBRARY_PATH" >> "$GITHUB_ENV"


      - name: Verify Vulkan installation
        run: vulkaninfo | grep -E 'driverName|deviceName|apiVersion'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ./requirements.txt
          pip install -r ./tooling-requirements.txt


      - name: brew install
        run: brew install repo

      - name: Clone repositories and build
        run: .github/workflows/scripts/ci_build.sh
        
