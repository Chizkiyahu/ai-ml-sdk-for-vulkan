#
# SPDX-FileCopyrightText: Copyright 2025 Arm Limited and/or its affiliates <open-source-office@arm.com>
# SPDX-License-Identifier: Apache-2.0
#
name: Build ML SDK

on:
  workflow_dispatch:
    inputs:
      changed_repo: { type: string, required: false, default: "", description: "org/repo-a" }
      changed_sha:  { type: string, required: false, default: "", description: "40-char sha" }
      clean:        { type: boolean, required: false, default: false , description: "without cache" }
  workflow_call:
    inputs:
      changed_repo: { type: string, required: true, description: "org/repo-a" }
      changed_sha:  { type: string, required: true, description: "40-char sha" }
      clean:        { type: boolean, required: false, default: false , description: "without cache" }

permissions:
  contents: read
  packages: read

jobs:
  build:
    runs-on: ${{ matrix.platform }}
    strategy:
      matrix:
        include:
          - platform: ubuntu-24.04
            arch_tag: amd64
          - platform: ubuntu-24.04-arm
            arch_tag: arm64
      fail-fast: false

    container:
      image: ghcr.io/${{ github.repository_owner }}/ml-sdk-linux-${{ matrix.arch_tag }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root

    env:
      REPO_DIR:    /home/mlsdkuser/sdk
      INSTALL_DIR: /home/mlsdkuser/install
      MANIFEST_URL: https://github.com/${{ github.repository_owner }}/ai-ml-sdk-manifest.git
      CHANGED_REPO: ${{ inputs.changed_repo }}
      CHANGED_SHA: ${{ inputs.changed_sha }}

    steps:
      - name: clean
        if: ${{ inputs.clean == true }}
        run: |
            rm -rf $REPO_DIR
            rm -rf $INSTALL_DIR

      - name: update repositories and build
        run: /home/mlsdkuser/ci_build.sh
