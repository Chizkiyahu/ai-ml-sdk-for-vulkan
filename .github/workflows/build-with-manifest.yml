#
# SPDX-FileCopyrightText: Copyright 2025 Arm Limited and/or its affiliates <open-source-office@arm.com>
# SPDX-License-Identifier: Apache-2.0
#
name: Build ML SDK

on:
  push:
    branches:
      - ci_win_t1
  workflow_dispatch:
  workflow_call:
    inputs:
      changed_repo: { type: string, required: true }  # e.g., org/repo-a
      changed_sha:  { type: string, required: true }  # e.g., 40-char sha

permissions:
  contents: read
  packages: read

env:
  MANIFEST_URL: https://github.com/${{ github.repository_owner }}/ai-ml-sdk-manifest.git
  REPO_DIR:     ${{ github.workspace }}/sdk
  INSTALL_DIR:  ${{ github.workspace }}/install
  CHANGED_REPO: ${{ inputs.changed_repo }}
  CHANGED_SHA:  ${{ inputs.changed_sha }}

jobs:
#  build-linux:
#    runs-on: ${{ matrix.platform }}
#    strategy:
#      matrix:
#        include:
#          - platform: ubuntu-24.04
#            arch_tag: amd64
#          - platform: ubuntu-24.04-arm
#            arch_tag: arm64
#      fail-fast: false
#
#    container:
#      image: ghcr.io/${{ github.repository_owner }}/ml-sdk-linux-${{ matrix.arch_tag }}:latest
#      credentials:
#        username: ${{ github.actor }}
#        password: ${{ secrets.GITHUB_TOKEN }}
#      options: --user root
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Clone repositories and build
#        run: .github/workflows/scripts/ci_build.sh

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up MSVC (Developer Command Prompt)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          install_runtime: true
          install_lavapipe: true

      - name: Set Vulkan registry for lavapipe ICD
        shell: pwsh
        run: |
          Get-ChildItem "C:\lavapipe\share\vulkan\icd.d\"
          reg.exe add "HKLM\SOFTWARE\Khronos\Vulkan\Drivers" /v "C:\lavapipe\share\vulkan\icd.d\lvp_icd.x86_64.json" /t REG_DWORD /d 0 /f

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r ./requirements.txt

      - name: Install tools with Chocolatey
        shell: pwsh
        run: |
          choco install -y xmlstarlet
          xml.exe --version

      - name: Run CI build script (PowerShell, Windows only)
        shell: pwsh
        run: |
          # Enable long paths
          reg.exe add "HKLM\System\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f
          git config --global core.longpaths true
  
          # Clone git-repo (Python script)
          git clone https://gerrit.googlesource.com/git-repo "$env:GITHUB_WORKSPACE/git-repo"
  
          # Run the PowerShell CI script
          & "$env:GITHUB_WORKSPACE/.github/workflows/scripts/ci_build.ps1"

