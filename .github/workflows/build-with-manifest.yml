#
# SPDX-FileCopyrightText: Copyright 2025 Arm Limited and/or its affiliates <open-source-office@arm.com>
# SPDX-License-Identifier: Apache-2.0
#
name: Build ML SDK

on:
  push:
    branches:
      - ci_win_t1
  workflow_dispatch:
  workflow_call:
    inputs:
      changed_repo: { type: string, required: true }  # e.g., org/repo-a
      changed_sha:  { type: string, required: true }  # e.g., 40-char sha

permissions:
  contents: read
  packages: read

env:
  MANIFEST_URL: https://github.com/${{ github.repository_owner }}/ai-ml-sdk-manifest.git
  REPO_DIR:     ${{ github.workspace }}/sdk
  INSTALL_DIR:  ${{ github.workspace }}/install
  CHANGED_REPO: ${{ inputs.changed_repo }}
  CHANGED_SHA:  ${{ inputs.changed_sha }}

jobs:
#  build-linux:
#    runs-on: ${{ matrix.platform }}
#    strategy:
#      matrix:
#        include:
#          - platform: ubuntu-24.04
#            arch_tag: amd64
#          - platform: ubuntu-24.04-arm
#            arch_tag: arm64
#      fail-fast: false
#
#    container:
#      image: ghcr.io/${{ github.repository_owner }}/ml-sdk-linux-${{ matrix.arch_tag }}:latest
#      credentials:
#        username: ${{ github.actor }}
#        password: ${{ secrets.GITHUB_TOKEN }}
#      options: --user root
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Clone repositories and build
#        run: .github/workflows/scripts/ci_build.sh

  build-windows:
      runs-on: windows-latest
      steps:
        - uses: actions/checkout@v4

        - name: Set up MSVC (Developer Command Prompt)
          uses: ilammy/msvc-dev-cmd@v1
          with:
            arch: amd64


#        - name: Install Vulkan SDK
#          uses: jakoch/install-vulkan-sdk-action@v1
#          with:
#            install_runtime: true

#        - name: Setup Vulkan for CI
#          id: vulkan
#          uses: NcStudios/VulkanCI@v1.2
#          with:
#            sdkVersion: 1.4.309.0
#
#        - name: Register SwiftShader ICD in Vulkan registry
#          run: reg add "HKLM\SOFTWARE\Khronos\Vulkan\Drivers" /v "${{ steps.vulkan.outputs.swiftshader-install-path }}\vk_swiftshader_icd.json" /t REG_DWORD /d 0 /f
#
        - name: Vulkan-Tools
          shell: bash
          run: |
            # 1) Get and install Vulkan-Headers
            git clone https://github.com/KhronosGroup/Vulkan-Headers.git
            cd Vulkan-Headers
            cmake -S . -B build
            cmake --install build --prefix "$PWD/build/install"
            cd ..
            
            # This is where CMake config files now live:
            # $PWD/Vulkan-Headers/build/install/share/cmake/VulkanHeaders/VulkanHeadersConfig.cmake
            export VULKAN_HEADERS_INSTALL_DIR="$PWD/Vulkan-Headers/build/install"
            export VULKAN_HEADERS_INCLUDE_DIR="$VULKAN_HEADERS_INSTALL_DIR/include"
            
            # 2) Get Vulkan-Tools
            git clone https://github.com/KhronosGroup/Vulkan-Tools.git
            cd Vulkan-Tools
            
            # 3) Configure Vulkan-Tools and tell it where Vulkan-Headers is
            cmake -S . -B build \
              -DCMAKE_PREFIX_PATH="$VULKAN_HEADERS_INSTALL_DIR" \
              -DVULKAN_HEADERS_INSTALL_DIR="$VULKAN_HEADERS_INSTALL_DIR"
            
            # 4) Build and install Vulkan-Tools
            cmake --build build --config Release
            cmake --install build --config Release --prefix "$PWD/build/install"
            
            
            
#            VULKAN_ICD_PATH=$(wslpath -w "$json_file")
#            echo "VULKAN_ICD_PATH=$VULKAN_ICD_PATH"
#
#            MSYS2_ARG_CONV_EXCL='*' cmd.exe /c reg.exe add "HKLM\\SOFTWARE\\Khronos\\Vulkan\\Drivers" /v "$VULKAN_ICD_PATH" /t REG_DWORD /d 0
#
#
        - name: upload Vulkan-Tools artifacts
          if: always()
          uses: actions/upload-artifact@v5
          with:
            name: vulkan-tools-windows
            path: ./Vulkan-Tools/build

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.11'

        - name: install Python dependencies
          shell: bash
          run: |
            python -m pip install --upgrade pip
            pip install -r ./requirements.txt
#            pip install -r ./tooling-requirements.txt

        - name: Install tools with Chocolatey
          shell: pwsh
          run: |
            choco install -y graphviz
#           choco install -y doxygen.install xmlstarlet graphviz
            
#            $chocoBin = "C:\ProgramData\chocolatey\bin"
#            $chocoBin | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
#            Copy-Item "$chocoBin\xml.exe" "$chocoBin\xmlstarlet.exe" -Force
#            & "$chocoBin\xmlstarlet.exe" --version

        - name: Run CI build script
          shell: bash
          run: |
            cmd.exe /c "reg.exe add \"HKLM\System\CurrentControlSet\Control\FileSystem\" /v LongPathsEnabled /t REG_DWORD /d 1 /f"
            git config --global core.longpaths true
          
            # clone repo tool into the same drive as the workspace (GITHUB_WORKSPACE is on D:)
            git clone https://gerrit.googlesource.com/git-repo "$GITHUB_WORKSPACE/git-repo"

            # create a wrapper executable called `repo` in workspace and put it on PATH
            mkdir -p "$GITHUB_WORKSPACE/.local/bin"
            
            cat > "$GITHUB_WORKSPACE/.local/bin/repo" <<'EOF'
            #!/usr/bin/env bash
            python "$GITHUB_WORKSPACE/git-repo/repo" "$@"
            EOF
            
            chmod +x "$GITHUB_WORKSPACE/.local/bin/repo"
            export PATH="$GITHUB_WORKSPACE/.local/bin:$PATH"

            # run your CI script
            .github/workflows/scripts/ci_build.sh


        - name: upload build artifacts
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: ml-sdk-windows-build
            path: ${{ env.INSTALL_DIR }}